<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NLP Engine Test Suite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 40px;
            background: #f5f5f7;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 32px;
            margin-bottom: 10px;
            color: #1d1d1f;
        }

        .subtitle {
            font-size: 16px;
            color: #6e6e73;
            margin-bottom: 40px;
        }

        .test-section {
            margin-bottom: 40px;
        }

        .test-section h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #1d1d1f;
            border-bottom: 2px solid #0071e3;
            padding-bottom: 10px;
        }

        .test-case {
            background: #f5f5f7;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #d2d2d7;
        }

        .test-case.pass {
            border-left-color: #30d158;
            background: #f0fdf4;
        }

        .test-case.fail {
            border-left-color: #ff3b30;
            background: #fef2f2;
        }

        .test-input {
            font-weight: 600;
            margin-bottom: 10px;
            color: #1d1d1f;
        }

        .test-expected {
            font-size: 14px;
            color: #6e6e73;
            margin-bottom: 8px;
        }

        .test-result {
            font-size: 14px;
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
        }

        .test-result strong {
            color: #1d1d1f;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: #f5f5f7;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-number.pass {
            color: #30d158;
        }

        .stat-number.fail {
            color: #ff3b30;
        }

        .stat-number.accuracy {
            color: #0071e3;
        }

        .stat-label {
            font-size: 14px;
            color: #6e6e73;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button {
            background: #0071e3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
        }

        button:hover {
            background: #0077ed;
        }

        .json-output {
            background: #1d1d1f;
            color: #30d158;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß† NLP Engine Test Suite</h1>
        <p class="subtitle">Testing multi-layer intent recognition and entity extraction</p>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-number pass" id="passCount">0</div>
                <div class="stat-label">Passed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number fail" id="failCount">0</div>
                <div class="stat-label">Failed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number accuracy" id="accuracy">0%</div>
                <div class="stat-label">Accuracy</div>
            </div>
        </div>

        <button onclick="runAllTests()">üöÄ Run All Tests</button>
        <button onclick="clearResults()">üîÑ Clear Results</button>

        <div id="testResults"></div>
    </div>

    <!-- Load dependencies (cache-busted) -->
    <script src="./core/chatbot-config.js?v=2"></script>
    <script src="./core/chatbot-utils.js?v=2"></script>
    <script src="./intelligence/chatbot-intent-library.js?v=2"></script>
    <script src="./intelligence/chatbot-entity-extractor.js?v=2"></script>
    <script src="./intelligence/chatbot-nlp-engine.js?v=2"></script>

    <script>
        const testCases = [
            // ========================================
            // INTENT RECOGNITION TESTS
            // ========================================
            {
                category: 'Pricing Inquiries',
                tests: [
                    {
                        input: 'How much does it cost?',
                        expectedIntent: 'pricing_inquiry',
                        minConfidence: 0.85
                    },
                    {
                        input: 'What\'s the price?',
                        expectedIntent: 'pricing_inquiry',
                        minConfidence: 0.85
                    },
                    {
                        input: 'Is this affordable?',
                        expectedIntent: 'pricing_inquiry',
                        minConfidence: 0.6
                    }
                ]
            },
            {
                category: 'Get Started',
                tests: [
                    {
                        input: 'I need a website ASAP',
                        expectedIntent: 'get_started',
                        minConfidence: 0.7,
                        expectedEntities: {
                            timelineUrgency: 'urgent'
                        }
                    },
                    {
                        input: 'I want a website for my business',
                        expectedIntent: 'get_started',
                        minConfidence: 0.7
                    },
                    {
                        input: 'Can you build me a site?',
                        expectedIntent: 'get_started',
                        minConfidence: 0.7
                    }
                ]
            },
            {
                category: 'Business Type Recognition',
                tests: [
                    {
                        input: 'I own a restaurant in Portland',
                        expectedIntent: 'restaurant_mention',
                        minConfidence: 0.7,
                        expectedEntities: {
                            businessType: 'restaurant'
                        }
                    },
                    {
                        input: 'My salon needs a website',
                        expectedIntent: 'salon_mention',
                        minConfidence: 0.7,
                        expectedEntities: {
                            businessType: 'salon'
                        }
                    },
                    {
                        input: 'I run a fitness center',
                        expectedIntent: 'fitness_mention',
                        minConfidence: 0.7,
                        expectedEntities: {
                            businessType: 'fitness'
                        }
                    }
                ]
            },
            {
                category: 'Feature Requests',
                tests: [
                    {
                        input: 'I need online ordering for my restaurant',
                        expectedIntent: 'online_ordering_need',
                        minConfidence: 0.7,
                        expectedEntities: {
                            featuresNeeded: ['ordering'],
                            businessType: 'restaurant'
                        }
                    },
                    {
                        input: 'Do you do AI chatbots?',
                        expectedIntent: 'ai_chatbot_inquiry',
                        minConfidence: 0.7
                    },
                    {
                        input: 'I want online booking',
                        expectedIntent: 'online_booking_need',
                        minConfidence: 0.7,
                        expectedEntities: {
                            featuresNeeded: ['booking']
                        }
                    }
                ]
            },
            {
                category: 'Budget & Timeline',
                tests: [
                    {
                        input: 'This is too expensive',
                        expectedIntent: 'budget_concern',
                        minConfidence: 0.7
                    },
                    {
                        input: 'I have a tight budget',
                        expectedIntent: 'budget_tight',
                        minConfidence: 0.7,
                        expectedEntities: {
                            budgetRange: 'tight'
                        }
                    },
                    {
                        input: 'How long will it take?',
                        expectedIntent: 'timeline_inquiry',
                        minConfidence: 0.7
                    }
                ]
            },
            {
                category: 'Ready to Buy',
                tests: [
                    {
                        input: 'Let\'s do it!',
                        expectedIntent: 'ready_to_start',
                        minConfidence: 0.85
                    },
                    {
                        input: 'I\'m ready to get started',
                        expectedIntent: 'ready_to_start',
                        minConfidence: 0.7
                    },
                    {
                        input: 'Send me a quote',
                        expectedIntent: 'quote_request',
                        minConfidence: 0.85
                    }
                ]
            },
            {
                category: 'Package Inquiries',
                tests: [
                    {
                        input: 'Tell me about the professional package',
                        expectedIntent: 'professional_details',
                        minConfidence: 0.7
                    },
                    {
                        input: 'What\'s the difference between packages?',
                        expectedIntent: 'package_comparison',
                        minConfidence: 0.7
                    }
                ]
            },
            {
                category: 'Entity Extraction',
                tests: [
                    {
                        input: 'My restaurant is called Taco Fiesta',
                        expectedEntities: {
                            businessType: 'restaurant',
                            businessName: 'Taco Fiesta'
                        }
                    },
                    {
                        input: 'I can spend around $5000',
                        expectedEntities: {
                            budgetRange: 'professional'
                        }
                    },
                    {
                        input: 'I need it in 2 weeks',
                        expectedEntities: {
                            timelineUrgency: 'soon'
                        }
                    }
                ]
            }
        ];

        let passCount = 0;
        let failCount = 0;

        function runAllTests() {
            clearResults();
            passCount = 0;
            failCount = 0;

            const resultsContainer = document.getElementById('testResults');

            testCases.forEach(category => {
                const section = document.createElement('div');
                section.className = 'test-section';
                section.innerHTML = `<h2>${category.category}</h2>`;

                category.tests.forEach(test => {
                    const result = runTest(test);
                    const testDiv = document.createElement('div');
                    testDiv.className = `test-case ${result.passed ? 'pass' : 'fail'}`;

                    testDiv.innerHTML = `
                        <div class="test-input">"${test.input}"</div>
                        <div class="test-expected">
                            ${test.expectedIntent ? `Expected Intent: <strong>${test.expectedIntent}</strong> (min ${test.minConfidence} confidence)` : ''}
                            ${test.expectedEntities ? `<br>Expected Entities: <strong>${JSON.stringify(test.expectedEntities)}</strong>` : ''}
                        </div>
                        <div class="test-result">
                            <strong>Result:</strong> ${result.passed ? '‚úÖ PASS' : '‚ùå FAIL'}
                            <br><strong>Intent:</strong> ${result.actual.intent.name} (${result.actual.intent.confidence.toFixed(2)} confidence)
                            <br><strong>Entities Found:</strong> ${JSON.stringify(result.actual.entities, null, 2)}
                            ${!result.passed ? `<br><strong>Reason:</strong> ${result.reason}` : ''}
                        </div>
                        <div class="json-output">${JSON.stringify(result.actual, null, 2)}</div>
                    `;

                    section.appendChild(testDiv);

                    if (result.passed) {
                        passCount++;
                    } else {
                        failCount++;
                    }
                });

                resultsContainer.appendChild(section);
            });

            updateStats();
        }

        function runTest(test) {
            const result = ChatbotNLPEngine.process(test.input);

            let passed = true;
            let reason = '';

            // Check intent
            if (test.expectedIntent) {
                if (result.intent.name !== test.expectedIntent) {
                    passed = false;
                    reason = `Expected intent "${test.expectedIntent}", got "${result.intent.name}"`;
                } else if (result.intent.confidence < test.minConfidence) {
                    passed = false;
                    reason = `Confidence too low: ${result.intent.confidence.toFixed(2)} < ${test.minConfidence}`;
                }
            }

            // Check entities
            if (test.expectedEntities && passed) {
                for (const [key, expectedValue] of Object.entries(test.expectedEntities)) {
                    const actualValue = result.entities[key];

                    if (Array.isArray(expectedValue)) {
                        // Check if arrays have common elements
                        if (!actualValue || !expectedValue.some(v => actualValue.includes(v))) {
                            passed = false;
                            reason = `Entity "${key}" mismatch: expected ${JSON.stringify(expectedValue)}, got ${JSON.stringify(actualValue)}`;
                            break;
                        }
                    } else {
                        if (actualValue !== expectedValue) {
                            passed = false;
                            reason = `Entity "${key}" mismatch: expected "${expectedValue}", got "${actualValue}"`;
                            break;
                        }
                    }
                }
            }

            return {
                passed,
                reason,
                actual: result
            };
        }

        function updateStats() {
            const total = passCount + failCount;
            const accuracy = total > 0 ? ((passCount / total) * 100).toFixed(1) : 0;

            document.getElementById('passCount').textContent = passCount;
            document.getElementById('failCount').textContent = failCount;
            document.getElementById('accuracy').textContent = accuracy + '%';
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            passCount = 0;
            failCount = 0;
            updateStats();
        }

        // Run tests automatically on page load
        window.addEventListener('load', () => {
            console.log('%cüß† NLP Engine Test Suite Loaded', 'font-size: 20px; font-weight: bold; color: #0071e3;');
            console.log('%cAuto-running tests...', 'font-size: 14px; color: #6e6e73;');

            // Auto-run tests after a brief delay to ensure all scripts are loaded
            setTimeout(() => {
                runAllTests();
            }, 100);
        });
    </script>
</body>
</html>
